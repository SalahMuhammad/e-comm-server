<!-- templates/reports/item_movement_report.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Movement Report</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-chart-line"></i>
                    Item Movement Report
                </h1>

                <!-- Report Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter"></i>
                            Report Filters
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if error %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            {{ error }}
                        </div>
                        {% endif %}

                        <form method="post" class="row g-3">
                            {% csrf_token %}

                            <div class="col-md-3">
                                <label for="item_id" class="form-label">Item *</label>
                                <select id="item_id" name="item_id" class="form-select" required>
                                    <option value="">Select Item</option>
                                    {% for item in items %}

                                    دي او الى معمولة كومنت صح
                                    <option value="{{ item.id }}" 
        {% if filters.item_id == item.id|stringformat:"s" or selected_item_id == item.id %}selected{% endif %}>
        {{ item.name }} {% if item.sku %}({{ item.sku }}){% endif %} 
    </option>
                                        <!-- <option value="{{ item.id }}" {% if filters.item_id==item.id|stringformat:"s" or
                                            selected_item_id==item.id %}selected{% endif %}>
                                            {{ item.name }} {% if item.sku %}({{ item.sku }}){% endif %}
                                        </option> -->
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" id="start_date" name="start_date" class="form-control"
                                    value="{{ filters.start_date|date:'Y-m-d' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" id="end_date" name="end_date" class="form-control"
                                    value="{{ filters.end_date|date:'Y-m-d' }}">
                            </div>

                            <div class="col-md-3">
                                <label for="repository_id" class="form-label">Repository</label>
                                <select id="repository_id" name="repository_id" class="form-select">
                                    <option value="">All Repositories</option>
                                    {% for repo in repositories %}
                                    <option value="{{ repo.id }}" {% if filters.repository_id==repo.id %}selected{%
                                        endif %}>
                                        {{ repo.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="export_format" class="form-label">Export</label>
                                <select id="export_format" name="export_format" class="form-select">
                                    <option value="html">View Report</option>
                                    <option value="csv">Export CSV</option>
                                    <option value="json">Export JSON</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play"></i>
                                    Generate Report
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Report Results -->
                {% if report_data %}
                <div class="report-results">
                    <!-- Item Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i>
                                Report Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Item:</strong> {{ report_data.item.name }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Period:</strong>
                                    {% if report_data.period.start_date %}{{ report_data.period.start_date }}{% else
                                    %}All time{% endif %}
                                    to
                                    {% if report_data.period.end_date %}{{ report_data.period.end_date }}{% else
                                    %}Present{% endif %}
                                </div>
                                <div class="col-md-3">
                                    <strong>Repository:</strong>
                                    {% if report_data.period.repository_id %}
                                    {% for repo in repositories %}
                                    {% if repo.id == report_data.period.repository_id %}{{ repo.name }}{% endif %}
                                    {% endfor %}
                                    {% else %}
                                    All Repositories
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <strong>Generated:</strong> {% now "Y-m-d H:i:s" %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-warehouse"></i>
                                Stock Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-info">Initial Stock</h5>
                                            <h3 class="card-text">{{ report_data.stock_summary.initial_stock }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-success">Final Stock</h5>
                                            <h3 class="card-text">{{ report_data.stock_summary.final_stock }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div
                                        class="card border-{% if report_data.stock_summary.net_movement >= 0 %}success{% else %}danger{% endif %}">
                                        <div class="card-body text-center">
                                            <h5
                                                class="card-title text-{% if report_data.stock_summary.net_movement >= 0 %}success{% else %}danger{% endif %}">
                                                Net Movement
                                            </h5>
                                            <h3 class="card-text">
                                                {% if report_data.stock_summary.net_movement >= 0 %}+{% endif %}{{
                                                report_data.stock_summary.net_movement }}
                                            </h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h5 class="card-title text-warning">Total Movements</h5>
                                            <h3 class="card-text">{{ report_data.movements|length }}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Movement Totals -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar"></i>
                                Movement Totals
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-success fw-bold">IN</div>
                                        <div class="h5">{{ report_data.movement_totals.total_in }}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-danger fw-bold">OUT</div>
                                        <div class="h5">{{ report_data.movement_totals.total_out }}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-primary fw-bold">Purchases</div>
                                        <div class="h5">{{ report_data.movement_totals.purchase_quantity }}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-warning fw-bold">Sales</div>
                                        <div class="h5">{{ report_data.movement_totals.sales_quantity }}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-info fw-bold">Transfers In</div>
                                        <div class="h5">{{ report_data.movement_totals.transfer_in_quantity }}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="text-center p-3 bg-light rounded">
                                        <div class="text-secondary fw-bold">Transfers Out</div>
                                        <div class="h5">{{ report_data.movement_totals.transfer_out_quantity }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Movement Details -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list"></i>
                                Movement Details
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleBreakdown()">
                                    <i class="fas fa-chart-pie"></i>
                                    Toggle Breakdown
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if report_data.movements %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Reference</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total Value</th>
                                            <th>Repository</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for movement in report_data.movements %}
                                        <tr class="movement-row" data-type="{{ movement.type }}">
                                            <td>{{ movement.date }}</td>
                                            <td>
                                                <span
                                                    class="badge bg-{% if movement.type == 'SALE' %}warning{% elif movement.type == 'PURCHASE' %}success{% elif movement.type == 'SALES_REFUND' %}info{% elif movement.type == 'PURCHASE_REFUND' %}danger{% elif 'TRANSFER' in movement.type %}secondary{% endif %}">
                                                    {{ movement.type|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <code>{{ movement.reference_number }}</code>
                                            </td>
                                            <td
                                                class="text-{% if movement.quantity >= 0 %}success{% else %}danger{% endif %} fw-bold">
                                                {% if movement.quantity >= 0 %}+{% endif %}{{ movement.quantity }}
                                            </td>
                                            <td>
                                                {% if movement.unit_price %}
                                                ${{ movement.unit_price|floatformat:2 }}
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            <td
                                                class="text-{% if movement.total_value >= 0 %}success{% else %}danger{% endif %}">
                                                {% if movement.total_value %}
                                                {% if movement.total_value >= 0 %}+{% endif %}${{
                                                movement.total_value|floatformat:2 }}
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                            <td>{{ movement.repository|default:"-" }}</td>
                                            <td>
                                                <small class="text-muted">{{ movement.notes|truncatechars:50 }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination info -->
                            <div class="mt-3">
                                <small class="text-muted">
                                    Total movements: {{ report_data.movements|length }}
                                </small>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No movements found</h5>
                                <p class="text-muted">No item movements found for the selected criteria.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Movement Breakdown -->
                    <div id="breakdown-section" class="card mb-4" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie"></i>
                                Movement Breakdown
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- By Type -->
                                <div class="col-md-4">
                                    <h6>By Movement Type</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Quantity</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for type, data in report_data.movement_breakdown.by_type.items %}
                                                <tr>
                                                    <td>{{ type|title }}</td>
                                                    <td
                                                        class="text-{% if data.quantity >= 0 %}success{% else %}danger{% endif %}">
                                                        {% if data.quantity >= 0 %}+{% endif %}{{ data.quantity }}
                                                    </td>
                                                    <td>{{ data.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- By Repository -->
                                <div class="col-md-4">
                                    <h6>By Repository</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Repository</th>
                                                    <th>Quantity</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for repo, data in report_data.movement_breakdown.by_repository.items
                                                %}
                                                <tr>
                                                    <td>{{ repo }}</td>
                                                    <td
                                                        class="text-{% if data.quantity >= 0 %}success{% else %}danger{% endif %}">
                                                        {% if data.quantity >= 0 %}+{% endif %}{{ data.quantity }}
                                                    </td>
                                                    <td>{{ data.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- By Month -->
                                <div class="col-md-4">
                                    <h6>By Month</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Month</th>
                                                    <th>Quantity</th>
                                                    <th>Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for month, data in report_data.movement_breakdown.by_month.items %}
                                                <tr>
                                                    <td>{{ month }}</td>
                                                    <td
                                                        class="text-{% if data.quantity >= 0 %}success{% else %}danger{% endif %}">
                                                        {% if data.quantity >= 0 %}+{% endif %}{{ data.quantity }}
                                                    </td>
                                                    <td>{{ data.count }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleBreakdown() {
            const breakdownSection = document.getElementById('breakdown-section');
            if (breakdownSection.style.display === 'none') {
                breakdownSection.style.display = 'block';
            } else {
                breakdownSection.style.display = 'none';
            }
        }

        // Add filtering functionality
        document.addEventListener('DOMContentLoaded', function () {
            // Auto-submit when export format changes to CSV or JSON
            document.getElementById('export_format').addEventListener('change', function () {
                if (this.value === 'csv' || this.value === 'json') {
                    // Check if item is selected
                    if (document.getElementById('item_id').value) {
                        document.querySelector('form').submit();
                    } else {
                        alert('Please select an item first');
                        this.value = 'html';
                    }
                }
            });
        });
    </script>
</body>

</html>